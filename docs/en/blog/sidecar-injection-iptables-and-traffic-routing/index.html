<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>Sidecar injection and transparent traffic hijacking process in Istio explained in detail</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description"
    content="Based on Istio version 1.5.1, this blog describes the sidecar pattern and its advantages. How sidecar be injected into the data plane, how traffic hijacking and forwarding is done, and how traffic is routed to upstream.">
  
  <meta name="author" content="wikieden">
  <meta name="generator" content="Hugo 0.80.0" />
  <!-- multilingual SEO optimizations -->
  

  <!-- plugins -->
  
  <link rel="stylesheet" href="http://wikieden.github.io/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="http://wikieden.github.io/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="http://wikieden.github.io/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="http://wikieden.github.io/plugins/venobox/venobox.css">
  
  <link rel="stylesheet" href="http://wikieden.github.io/plugins/themify-icons/themify-icons.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="http://wikieden.github.io/scss/style.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="http://wikieden.github.io/images/favicon.png" type="image/x-icon">
  <link rel="icon" href="http://wikieden.github.io/images/favicon.png" type="image/x-icon">

</head><body>
<!-- preloader start -->
<div class="preloader">
  
  <img src="http://wikieden.github.io/images/preloader.gif" alt="preloader">
  
</div>
<!-- preloader end -->

<header class="fixed-top header">
  
  
  
  <div class="navigation w-100 ">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-dark p-0">
        <a class="navbar-brand" href="/en"><img class="img-fluid"
            src="http://wikieden.github.io/images/logo.jpg" alt="Laughman&#39;s Voloblog about CloudNative/AR/VR/CV"></a>
        <button class="navbar-toggler rounded-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="http://wikieden.github.io">Home</a>
            </li>
            
            
            <li class="nav-item">
              <a class="nav-link" href="http://wikieden.github.io/en/about">About</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="http://wikieden.github.io/en/course">course</a>
            </li>
            
            
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                Pages
              </a>
              <div class="dropdown-menu">
                
                <a class="dropdown-item" href="http://wikieden.github.io/en/event">event</a>
                
                <a class="dropdown-item" href="http://wikieden.github.io/en/notice">notice</a>
                
                <a class="dropdown-item" href="http://wikieden.github.io/en/research">research</a>
                
                <a class="dropdown-item" href="http://wikieden.github.io/en/scholarship">scholarship</a>
                
                <a class="dropdown-item" href="http://wikieden.github.io/en/teacher">teacher</a>
                
              </div>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="http://wikieden.github.io/en/blog">blog</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="http://wikieden.github.io/en/contact">Contact</a>
            </li>
            
            
          </ul>

          
          
        </div>
      </nav>
    </div>
  </div>
</header>


	
<section class="page-title-section overlay" style="background-image: url('/images/backgrounds/page-title.jpg'),url('/images/backgrounds/page-title.jpg');" >
  <div class="container">
    <div class="row">
      <div class="col-md-8">
        <ul class="list-inline custom-breadcrumb">
          <li class="list-inline-item h2"><a class="text-primary font-secondary" href="http://wikieden.github.io">Home</a></li>
          <li class="list-inline-item h5"><i class="ti-angle-right text-white"></i></li>
          <li class="list-inline-item text-white h3 font-secondary">Sidecar injection and transparent traffic hijacking process in Istio explained in detail</li>
        </ul>
        <p class="text-lighten">Based on Istio version 1.5.1, this blog describes the sidecar pattern and its advantages. How sidecar be injected into the data plane, how traffic hijacking and forwarding is done, and how traffic is routed to upstream.</p>
      </div>
    </div>
  </div>
</section>
	


<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 order-2 order-lg-1">
        <div class="row">
          <div class="col-12 mb-4">
            <img src="/images/banner/istio-logo.jpg" alt="blog-thumb" class="img-fluid w-100">
          </div>
          <div class="col-12">
            <ul class="list-inline">
              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Posted by
                  :</span><a
                  href="/en/author/"></a></li>

              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Date
                  :</span>27 Apr, 2020</li>

              <li class="list-inline-item mr-4 mb-3 mb-md-0 text-light"><span class="font-weight-bold mr-2">Category
                  :</span><a
                  href="/en/categories/istio"> 
                  Istio</a> </li>

            </ul>
          </div>
          
          <div class="col-12 my-4">
            <div class="border-bottom"></div>
          </div>
          
          <div class="col-12 content">
            <p>Based on Istio version 1.5.1, this article will present the following.</p>
<ul>
<li>What is the sidecar pattern and what advantages does it have?</li>
<li>How are sidecar injections done in Istio?</li>
<li>How does Sidecar proxy do transparent traffic hijacking?</li>
<li>How is the traffic routed to upstream?</li>
</ul>
<p>A year ago, I have written about <a href="/en/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/">understanding Envoy proxy Sidecar injection and traffic hijacking in Istio Service Mesh</a> which was based on Istio version 1.1. The biggest changes in the sidecar injection and traffic hijacking link between Istio 1.5 and Istio 1.1 are:</p>
<ul>
<li>iptables switched to a command-line tool and no longer uses shell scripts.</li>
<li>The sidecar inbound and outbound specify the ports separately, whereas previously the same port (15001) was used.</li>
</ul>
<p>Note: Portions of this article are included in the <a href="https://www.servicemesher.com/istio-handbook/">Istio Handbook</a> from the ServiceMesher community.</p>
<p>Read the Chinese version: <a href="/blog/sidecar-injection-iptables-and-traffic-routing">阅读中文版</a></p>
<h2 id="sidecar-pattern">Sidecar pattern</h2>
<p>Dividing the functionality of an application into separate processes running in the same minimal scheduling unit (e.g. Pod in Kubernetes) can be considered sidecar mode. As shown in the figure below, Sidecar pattern allows you to add more features next to your application without additional third-party component configuration or modifications to the application code.</p>
<p><img src="sidecar-pattern.png" alt="Sidecar pattern"></p>
<p>The Sidecar application is loosely coupled to the main application. It can shield the differences of different programming languages and unify the functions of microservices such as observability, monitoring, logging, configuration, circuit breaker, etc.</p>
<h3 id="advantages-of-using-the-sidecar-pattern">Advantages of using the Sidecar pattern</h3>
<p>When deploying a service grid using SIDECAR mode, there is no need to run an agent on the node, but multiple copies of the same SIDECAR will run in the cluster. In the sidecar deployment method, a companion container (such as Envoy or MOSN) is deployed next to each application&rsquo;s container, which is called a sidecar container. the sidecar takes over all traffic in and out of the application container. In Kubernetes' Pod, a sidecar container is injected next to the original application container, and the two containers share storage, networking, and other resources.</p>
<p>Due to its unique deployment architecture, the sidecar model offers the following advantages.</p>
<ul>
<li>Abstracting functions unrelated to application business logic into a common infrastructure reduces the complexity of microservice code.</li>
<li>Reduce code duplication in microservices architectures because it is no longer necessary to write the same third-party component profiles and code.</li>
<li>Sidecar can be independently upgraded to reduce the coupling of application code to the underlying platform.</li>
</ul>
<h2 id="sidecar-injection-in-istio">Sidecar injection in Istio</h2>
<p>The following two sidecar injection methods are available in Istio.</p>
<ul>
<li>Manual injection using <code>istioctl</code>.</li>
<li>Kubernetes-based <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">mutating webhook admission controller</a> automatic sidecar injection method.</li>
</ul>
<p>Whether injected manually or automatically, SIDECAR&rsquo;s injection process follows the following steps.</p>
<ol>
<li>Kubernetes needs to know the Istio cluster to which the sidecar to be injected is connected and its configuration.</li>
<li>Kubernetes needs to know the configuration of the sidecar container itself to be injected, such as the image address, boot parameters, etc.</li>
<li>Kubernetes injects the above configuration into the side of the application container by the sidecar injection template and the configuration parameters of the above configuration-filled sidecar.</li>
</ol>
<p>The sidecar can be injected manually using the following command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">istioctl kube-inject -f <span style="color:#e6db74">${</span>YAML_FILE<span style="color:#e6db74">}</span> | kuebectl apply -f -
</code></pre></div><p>This command is injected using Istio&rsquo;s built-in sidecar configuration, see the <a href="https://istio.io">Istio official website</a> for details on how to use Istio below.</p>
<p>When the injection is complete you will see that Istio has injected initContainer and sidecar proxy related configurations into the original pod template.</p>
<h3 id="init-container">Init container</h3>
<p>The Init container is a dedicated container that runs before the application container is launched and is used to contain some utilities or installation scripts that do not exist in the application image.</p>
<p>Multiple Init containers can be specified in a Pod, and if more than one is specified, the Init containers will run sequentially. The next Init container can only be run if the previous Init container must run successfully. Kubernetes only initializes the Pod and runs the application container when all the Init containers have been run.</p>
<p>The Init container uses Linux Namespace, so it has a different view of the file system than the application container. As a result, they can have access to Secret in a way that application containers cannot.</p>
<p>During Pod startup, the Init container starts sequentially after the network and data volumes are initialized. Each container must be successfully exited before the next container can be started. If exiting due to a error will result in a container startup failure, it will retry according to the policy specified in the Pod&rsquo;s restartPolicy. However, if the Pod&rsquo;s restartPolicy is set to Always, the restartPolicy is used when the Init container failed.</p>
<p>The Pod will not become Ready until all Init containers are successful. The ports of the Init containers will not be aggregated in the Service. The Pod that is being initialized is in the Pending state, but should set the Initializing state to true. The Init container will automatically terminate once it is run.</p>
<h2 id="sidecar-injection-example-analysis">Sidecar injection example analysis</h2>
<p>For a detailed YAML configuration for bookinfo applications, see bookinfo.yaml for the official Istio YAML of productpage in bookinfo sample.</p>
<p>The following will be explained in the following terms.</p>
<ul>
<li>Injection of Sidecar containers</li>
<li>Creation of iptables rules</li>
<li>The detailed process of routing</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">productpage-v1</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">productpage</span>
    <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">productpage</span>
      <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">productpage</span>
        <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">serviceAccountName</span>: <span style="color:#ae81ff">bookinfo-productpage</span>
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">productpage</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.io/istio/examples-bookinfo-productpage-v1:1.15.0</span>
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9080</span>
        <span style="color:#f92672">volumeMounts</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tmp</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/tmp</span>
      <span style="color:#f92672">volumes</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tmp</span>
        <span style="color:#f92672">emptyDir</span>: {}
</code></pre></div><p>Let&rsquo;s see the <code>productpage</code> container’s <a href="https://github.com/istio/istio/blob/master/samples/bookinfo/src/productpage/Dockerfile">Dockerfile</a>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.7.4-slim</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> requirements.txt ./<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install --no-cache-dir -r requirements.txt<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> test-requirements.txt ./<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install --no-cache-dir -r test-requirements.txt<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> productpage.py /opt/microservices/<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> tests/unit/* /opt/microservices/<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> templates /opt/microservices/templates<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> static /opt/microservices/static<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> requirements.txt /opt/microservices/<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> flood_factor<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> FLOOD_FACTOR <span style="color:#e6db74">${</span>flood_factor<span style="color:#66d9ef">:-</span>0<span style="color:#e6db74">}</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 9080</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /opt/microservices</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> python -m unittest discover<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> 1</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;python&#34;</span>, <span style="color:#e6db74">&#34;productpage.py&#34;</span>, <span style="color:#e6db74">&#34;9080&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>We see that <code>ENTRYPOINT</code> is not configured in Dockerfile, so <code>CMD</code>’s configuration <code>python productpage.py 9080</code> will be the default <code>ENTRYPOINT</code>, keep that in mind and look at the configuration after the sidecar injection.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div><p>We intercept only a portion of the YAML configuration that is part of the Deployment configuration associated with productpage.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.io/istio/examples-bookinfo-productpage-v1:1.15.0</span> <span style="color:#75715e"># application image</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">productpage</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">9080</span>
      - <span style="color:#f92672">args</span>:
        - <span style="color:#ae81ff">proxy</span>
        - <span style="color:#ae81ff">sidecar</span>
        - --<span style="color:#ae81ff">domain</span>
        - <span style="color:#ae81ff">$(POD_NAMESPACE).svc.cluster.local</span>
        - --<span style="color:#ae81ff">configPath</span>
        - <span style="color:#ae81ff">/etc/istio/proxy</span>
        - --<span style="color:#ae81ff">binaryPath</span>
        - <span style="color:#ae81ff">/usr/local/bin/envoy</span>
        - --<span style="color:#ae81ff">serviceCluster</span>
        - <span style="color:#ae81ff">productpage.$(POD_NAMESPACE)</span>
        - --<span style="color:#ae81ff">drainDuration</span>
        - <span style="color:#ae81ff">45s</span>
        - --<span style="color:#ae81ff">parentShutdownDuration</span>
        - <span style="color:#ae81ff">1m0s</span>
        - --<span style="color:#ae81ff">discoveryAddress</span>
        - <span style="color:#ae81ff">istiod.istio-system.svc:15012</span>
        - --<span style="color:#ae81ff">zipkinAddress</span>
        - <span style="color:#ae81ff">zipkin.istio-system:9411</span>
        - --<span style="color:#ae81ff">proxyLogLevel=warning</span>
        - --<span style="color:#ae81ff">proxyComponentLogLevel=misc:error</span>
        - --<span style="color:#ae81ff">connectTimeout</span>
        - <span style="color:#ae81ff">10s</span>
        - --<span style="color:#ae81ff">proxyAdminPort</span>
        - <span style="color:#e6db74">&#34;15000&#34;</span>
        - --<span style="color:#ae81ff">concurrency</span>
        - <span style="color:#e6db74">&#34;2&#34;</span>
        - --<span style="color:#ae81ff">controlPlaneAuthPolicy</span>
        - <span style="color:#ae81ff">NONE</span>
        - --<span style="color:#ae81ff">dnsRefreshRate</span>
        - <span style="color:#ae81ff">300s</span>
        - --<span style="color:#ae81ff">statusPort</span>
        - <span style="color:#e6db74">&#34;15020&#34;</span>
        - --<span style="color:#ae81ff">trust-domain=cluster.local</span>
        - --<span style="color:#ae81ff">controlPlaneBootstrap=false</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.io/istio/proxyv2:1.5.1</span> <span style="color:#75715e"># sidecar proxy</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">istio-proxy</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">15090</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http-envoy-prom</span>
          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
      <span style="color:#f92672">initContainers</span>:
      - <span style="color:#f92672">command</span>:
        - <span style="color:#ae81ff">istio-iptables</span>
        - -<span style="color:#ae81ff">p</span>
        - <span style="color:#e6db74">&#34;15001&#34;</span>
        - -<span style="color:#ae81ff">z</span>
        - <span style="color:#e6db74">&#34;15006&#34;</span>
        - -<span style="color:#ae81ff">u</span>
        - <span style="color:#e6db74">&#34;1337&#34;</span>
        - -<span style="color:#ae81ff">m</span>
        - <span style="color:#ae81ff">REDIRECT</span>
        - -<span style="color:#ae81ff">i</span>
        - <span style="color:#e6db74">&#39;*&#39;</span>
        - -<span style="color:#ae81ff">x</span>
        - <span style="color:#e6db74">&#34;&#34;</span>
        - -<span style="color:#ae81ff">b</span>
        - <span style="color:#e6db74">&#39;*&#39;</span>
        - -<span style="color:#ae81ff">d</span>
        - <span style="color:#ae81ff">15090</span>,<span style="color:#ae81ff">15020</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.io/istio/proxyv2:1.5.1</span> <span style="color:#75715e"># init container</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">istio-init</span>
</code></pre></div><p>Istio&rsquo;s configuration for application Pod injection mainly includes:</p>
<ul>
<li>Init container <code>istio-init</code>: for setting iptables port forwarding in pod</li>
<li>Sidecar container <code>istio-proxy</code>: running a sidecar proxy, such as Envoy or MOSN</li>
</ul>
<p>The two containers will be parsed separately.</p>
<h2 id="init-container-analysis">Init container analysis</h2>
<p>The Init container that Istio injects into the pod is named istio-init, and we see in the YAML file above after Istio&rsquo;s injection is complete that the init command for this container is.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">istio-iptables -p <span style="color:#ae81ff">15001</span> -z <span style="color:#ae81ff">15006</span> -u <span style="color:#ae81ff">1337</span> -m REDIRECT -i <span style="color:#e6db74">&#39;*&#39;</span> -x <span style="color:#e6db74">&#34;&#34;</span> -b <span style="color:#e6db74">&#39;*&#39;</span> -d 15090,15020
</code></pre></div><p>Let&rsquo;s check the container&rsquo;s Dockerfile again to see how <code>ENTRYPOINT</code> determines what commands are executed at startup.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#75715e"># ommit</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># The pilot-agent will bootstrap Envoy.</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;/usr/local/bin/pilot-agent&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>We see that the entrypoint of the istio-init container is the <code>/usr/local/bin/istio-iptables</code> command line, and the location of the code for this command line tool is in the <code>tools/istio-iptables</code> directory of the Istio source code repository.</p>
<p>Note: In Istio version 1.1, the <code>isito-iptables.sh</code> command line is still used to operate IPtables.</p>
<h3 id="init-container-initiation">Init container initiation</h3>
<p>The Init container&rsquo;s entrypoint is the <code>istio-iptables</code> command line, which is used as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Usage:
  istio-iptables <span style="color:#f92672">[</span>flags<span style="color:#f92672">]</span>

Flags:
  -n, --dry-run                                     Do not call any external dependencies like iptables
  -p, --envoy-port string                           Specify the envoy port to which redirect all TCP traffic <span style="color:#f92672">(</span>default $ENVOY_PORT <span style="color:#f92672">=</span> 15001<span style="color:#f92672">)</span>
  -h, --help                                        help <span style="color:#66d9ef">for</span> istio-iptables
  -z, --inbound-capture-port string                 Port to which all inbound TCP traffic to the pod/VM should be redirected to <span style="color:#f92672">(</span>default $INBOUND_CAPTURE_PORT <span style="color:#f92672">=</span> 15006<span style="color:#f92672">)</span>
      --iptables-probe-port string                  set listen port <span style="color:#66d9ef">for</span> failure detection <span style="color:#f92672">(</span>default <span style="color:#e6db74">&#34;15002&#34;</span><span style="color:#f92672">)</span>
  -m, --istio-inbound-interception-mode string      The mode used to redirect inbound connections to Envoy, either <span style="color:#e6db74">&#34;REDIRECT&#34;</span> or <span style="color:#e6db74">&#34;TPROXY&#34;</span>
  -b, --istio-inbound-ports string                  Comma separated list of inbound ports <span style="color:#66d9ef">for</span> which traffic is to be redirected to Envoy <span style="color:#f92672">(</span>optional<span style="color:#f92672">)</span>. The wildcard character <span style="color:#e6db74">&#34;*&#34;</span> can be used to configure redirection <span style="color:#66d9ef">for</span> all ports. An empty list will disable
  -t, --istio-inbound-tproxy-mark string
  -r, --istio-inbound-tproxy-route-table string
  -d, --istio-local-exclude-ports string            Comma separated list of inbound ports to be excluded from redirection to Envoy <span style="color:#f92672">(</span>optional<span style="color:#f92672">)</span>. Only applies  when all inbound traffic <span style="color:#f92672">(</span>i.e. <span style="color:#e6db74">&#34;*&#34;</span><span style="color:#f92672">)</span> is being redirected <span style="color:#f92672">(</span>default to $ISTIO_LOCAL_EXCLUDE_PORTS<span style="color:#f92672">)</span>
  -o, --istio-local-outbound-ports-exclude string   Comma separated list of outbound ports to be excluded from redirection to Envoy
  -i, --istio-service-cidr string                   Comma separated list of IP ranges in CIDR form to redirect to envoy <span style="color:#f92672">(</span>optional<span style="color:#f92672">)</span>. The wildcard character <span style="color:#e6db74">&#34;*&#34;</span> can be used to redirect all outbound traffic. An empty list will disable all outbound
  -x, --istio-service-exclude-cidr string           Comma separated list of IP ranges in CIDR form to be excluded from redirection. Only applies when all  outbound traffic <span style="color:#f92672">(</span>i.e. <span style="color:#e6db74">&#34;*&#34;</span><span style="color:#f92672">)</span> is being redirected <span style="color:#f92672">(</span>default to $ISTIO_SERVICE_EXCLUDE_CIDR<span style="color:#f92672">)</span>
  -k, --kube-virt-interfaces string                 Comma separated list of virtual interfaces whose inbound traffic <span style="color:#f92672">(</span>from VM<span style="color:#f92672">)</span> will be treated as outbound
      --probe-timeout duration                      failure detection timeout <span style="color:#f92672">(</span>default 5s<span style="color:#f92672">)</span>
  -g, --proxy-gid string                            Specify the GID of the user <span style="color:#66d9ef">for</span> which the redirection is not applied. <span style="color:#f92672">(</span>same default value as -u param<span style="color:#f92672">)</span>
  -u, --proxy-uid string                            Specify the UID of the user <span style="color:#66d9ef">for</span> which the redirection is not applied. Typically, this is the UID of the proxy container
  -f, --restore-format                              Print iptables rules in iptables-restore interpretable format <span style="color:#f92672">(</span>default true<span style="color:#f92672">)</span>
      --run-validation                              Validate iptables
      --skip-rule-apply                             Skip iptables apply
</code></pre></div><p>The above incoming parameters are reassembled into iptables rules. For more information on how to use this command, visit <code>tools/istio-iptables/pkg/cmd/root.go</code>.</p>
<p>The significance of the container&rsquo;s existence is that it allows the sidecar agent to intercept all inbound and outbound traffic to the pod, redirect all inbound traffic to port 15006 (sidecar) except port 15090 (used by Mixer) and port 15092 (Ingress Gateway), and then intercept outbound traffic from the application container which is processed by sidecar (listening through port 15001) and then outbound. See the <a href="https://istio.io/docs/ops/deployment/requirements/">official Istio documentation</a> for port usage in Istio.</p>
<p><strong>Command analysis</strong></p>
<p>Here is the purpose of this start-up command.</p>
<ul>
<li>Forward all traffic from the application container to port 15006 of the sidecar.</li>
<li>Run with the istio-proxy user identity, with a UID of 1337, the user space where the sidecar is located, which is the default user used by the istio-proxy container, see the runAsUser field of the YAML configuration.</li>
<li>Use the default REDIRECT mode to redirect traffic.</li>
<li>Redirect all outbound traffic to the sidecar proxy (via port 15001).</li>
</ul>
<p>Because the Init container is automatically terminated after initialization, since we cannot log into the container to view the iptables information, but the Init container initialization results are retained in the application container and sidecar container.</p>
<h2 id="iptables-manipulation-analysis">iptables manipulation analysis</h2>
<p>In order to view the iptables configuration, we need to <code>nsente</code>r the sidecar container using the root user to view it, because kubectl cannot use privileged mode to remotely manipulate the docker container, so we need to log on the host where the productpage pod is located.</p>
<p>If you use Kubernetes deployed by minikube, you can log directly into the minikube&rsquo;s virtual machine and switch to root. View the iptables configuration that lists all the rules for the NAT (Network Address Translation) table because the mode for redirecting inbound traffic to the sidecar is REDIRECT in the parameters passed to the istio-iptables when the Init container is selected for startup, so there will only be NAT table specifications in the iptables and mangle table configurations if TPROXY is selected. See the iptables command for detailed usage.</p>
<p>We only look at the iptables rules related to <code>productpage</code> below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># login to minikube, change user to root</span>
$ minikube ssh
$ sudo -i

<span style="color:#75715e"># See the processes in the productpage pod&#39;s istio-proxy container</span>
$ docker top <span style="color:#e6db74">`</span>docker ps|grep <span style="color:#e6db74">&#34;istio-proxy_productpage&#34;</span>|cut -d <span style="color:#e6db74">&#34; &#34;</span> -f1<span style="color:#e6db74">`</span>
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
<span style="color:#ae81ff">1337</span>                <span style="color:#ae81ff">10576</span>               <span style="color:#ae81ff">10517</span>               <span style="color:#ae81ff">0</span>                   08:09               ?                   00:00:07            /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --configPath /etc/istio/proxy --binaryPath /usr/local/bin/envoy --serviceCluster productpage.default --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istiod.istio-system.svc:15012 --zipkinAddress zipkin.istio-system:9411 --proxyLogLevel<span style="color:#f92672">=</span>warning --proxyComponentLogLevel<span style="color:#f92672">=</span>misc:error --connectTimeout 10s --proxyAdminPort <span style="color:#ae81ff">15000</span> --concurrency <span style="color:#ae81ff">2</span> --controlPlaneAuthPolicy NONE --dnsRefreshRate 300s --statusPort <span style="color:#ae81ff">15020</span> --trust-domain<span style="color:#f92672">=</span>cluster.local --controlPlaneBootstrap<span style="color:#f92672">=</span>false
<span style="color:#ae81ff">1337</span>                <span style="color:#ae81ff">10660</span>               <span style="color:#ae81ff">10576</span>               <span style="color:#ae81ff">0</span>                   08:09               ?                   00:00:33            /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch <span style="color:#ae81ff">0</span> --drain-time-s <span style="color:#ae81ff">45</span> --parent-shutdown-time-s <span style="color:#ae81ff">60</span> --service-cluster productpage.default --service-node sidecar~172.17.0.16~productpage-v1-7f44c4d57c-ksf9b.default~default.svc.cluster.local --max-obj-name-len <span style="color:#ae81ff">189</span> --local-address-ip-version v4 --log-format <span style="color:#f92672">[</span>Envoy <span style="color:#f92672">(</span>Epoch 0<span style="color:#f92672">)]</span> <span style="color:#f92672">[</span>%Y-%m-%d %T.%e<span style="color:#f92672">][</span>%t<span style="color:#f92672">][</span>%l<span style="color:#f92672">][</span>%n<span style="color:#f92672">]</span> %v -l warning --component-log-level misc:error --concurrency <span style="color:#ae81ff">2</span>

<span style="color:#75715e"># Enter the nsenter into the namespace of the sidecar container (any of the above is ok)</span>
$ nsenter -n --target <span style="color:#ae81ff">10660</span>
</code></pre></div><p>View the process&rsquo;s iptables rule chain under its namespace.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># View the details of the rule configuration in the NAT table.</span>
$ iptables -t nat -L -v
<span style="color:#75715e"># PREROUTING chain: Used for Destination Address Translation (DNAT) to jump all incoming TCP traffic to the ISTIO_INBOUND chain.</span>
Chain PREROUTING <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">2701</span> packets, 162K bytes<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination
 <span style="color:#ae81ff">2701</span>  162K ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere

<span style="color:#75715e"># INPUT chain: Processes incoming packets and non-TCP traffic will continue on the OUTPUT chain.</span>
Chain INPUT <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">2701</span> packets, 162K bytes<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination

<span style="color:#75715e"># OUTPUT chain: jumps all outbound packets to the ISTIO_OUTPUT chain.</span>
Chain OUTPUT <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">79</span> packets, <span style="color:#ae81ff">6761</span> bytes<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination
   <span style="color:#ae81ff">15</span>   <span style="color:#ae81ff">900</span> ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere

<span style="color:#75715e"># POSTROUTING CHAIN: All packets must first enter the POSTROUTING chain when they leave the network card, and the kernel determines whether they need to be forwarded out according to the packet destination.</span>
Chain POSTROUTING <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">79</span> packets, <span style="color:#ae81ff">6761</span> bytes<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination

<span style="color:#75715e"># ISTIO_INBOUND CHAIN: Redirects all inbound traffic to the ISTIO_IN_REDIRECT chain, except for traffic destined for ports 15090 (used by mixer) and 15020 (used by Ingress gateway for Pilot health checks), and traffic sent to these two ports will return to the call point of the iptables rule chain, the successor POSTROUTING to the PREROUTING chain.</span>
Chain ISTIO_INBOUND <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> references<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
    <span style="color:#ae81ff">2</span>   <span style="color:#ae81ff">120</span> RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090
 <span style="color:#ae81ff">2699</span>  162K RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ISTIO_IN_REDIRECT  tcp  --  any    any     anywhere             anywhere

<span style="color:#75715e"># ISTIO_IN_REDIRECT chain: jumps all inbound traffic to the local 15006 port, thus successfully blocking traffic to the sidecar.</span>
Chain ISTIO_IN_REDIRECT <span style="color:#f92672">(</span><span style="color:#ae81ff">3</span> references<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span style="color:#ae81ff">15006</span>

<span style="color:#75715e"># ISTIO_OUTPUT chain: select the outbound traffic that needs to be redirected to Envoy (i.e., local), and all non-localhost traffic is forwarded to ISTIO_REDIRECT. to avoid infinite loops in the pod, all traffic to the istio-proxy userspace is returned to the next rule in its call point, which in this case is the OUTPUT chain, because jumping out of the ISTIO_OUTPUT rule leads to the next chain POSTROUTING. if the destination is non-localhost, jump to ISTIO_REDIRECT; if the traffic is from the istio-proxy userspace, jump out of the chain, return its call chain to continue the next rule (the next rule of OUTPUT, without processing the traffic); all non-istio-proxy userspace traffic whose destination is localhost, jump to ISTIO_REDIRECT.</span>
Chain ISTIO_OUTPUT <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> references<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> RETURN     all  --  any    lo      127.0.0.6            anywhere
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match <span style="color:#ae81ff">1337</span>
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match <span style="color:#ae81ff">1337</span>
   <span style="color:#ae81ff">15</span>   <span style="color:#ae81ff">900</span> RETURN     all  --  any    any     anywhere             anywhere             owner UID match <span style="color:#ae81ff">1337</span>
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match <span style="color:#ae81ff">1337</span>
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match <span style="color:#ae81ff">1337</span>
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> RETURN     all  --  any    any     anywhere             anywhere             owner GID match <span style="color:#ae81ff">1337</span>
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> RETURN     all  --  any    any     anywhere             localhost
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere

<span style="color:#75715e"># ISTIO_REDIRECT chain: redirects all traffic to Sidecar (i.e. local) port 15001.</span>
Chain ISTIO_REDIRECT <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> references<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination
    <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports <span style="color:#ae81ff">15001</span>
</code></pre></div><p>The figure below shows how the <code>productpage</code> service requests access to <code>http://reviews.default.svc.cluster.local:9080/</code> and how the sidecar proxy inside the reviews service does traffic blocking and routing forwarding when traffic goes inside the <code>reviews</code> service.</p>
<p><img src="envoy-sidecar-traffic-interception-jimmysong-blog-en.png" alt="Sidecar traffic injection"></p>
<p>At the beginning of the first step, the sidecar in the productpage pod has selected a pod of the reviews service to be requested via EDS, knows its IP address, and sends a TCP connection request.</p>
<p>There are three versions of the reviews service, each with an instance, and the sidecar work steps in the three versions are similar, as illustrated below only by the sidecar traffic forwarding step in one of the Pods.</p>
<h3 id="understand-iptables">Understand iptables</h3>
<p>iptables is a management tool for netfilter, the firewall software in the Linux kernel. netfilter is located in the user space and is part of netfilter. netfilter is located in the kernel space and has not only network address conversion, but also packet content modification and packet filtering firewall functions.</p>
<p>Before learning about iptables for Init container initialization, let&rsquo;s go over iptables and rule configuration.</p>
<p>The following figure shows the iptables call chain.</p>
<p><img src="iptables.jpg" alt="iptables chains"></p>
<h3 id="iptables">iptables</h3>
<p>The iptables version used in the Init container is v1.6.0 and contains 5 tables.</p>
<ol>
<li>RAW is used to configure packets. packets in RAW are not tracked by the system.</li>
<li>filter is the default table used to house all firewall-related operations.</li>
<li>NAT is used for network address translation (e.g., port forwarding).</li>
<li>mangle is used for modifications to specific packets (refer to corrupted packets).</li>
<li>security is used to force access to control network rules.</li>
</ol>
<p>Note: In this example, only the NAT table is used.</p>
<p>The chain types in the different tables are as follows.</p>
<table>
<thead>
<tr>
<th>Rule name</th>
<th>raw</th>
<th>filter</th>
<th>nat</th>
<th>mangle</th>
<th>security</th>
</tr>
</thead>
<tbody>
<tr>
<td>PREROUTING</td>
<td>✓</td>
<td></td>
<td>✓</td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td>INPUT</td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>OUTPUT</td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>POSTROUTING</td>
<td></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td>FORWARD</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td>✓</td>
<td>✓</td>
</tr>
</tbody>
</table>
<h3 id="understand-iptables-rules">Understand iptables rules</h3>
<p>View the default iptables rules in the <code>istio-proxy</code> container, the default view is the rules in the filter table.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ iptables -L -v
Chain INPUT <span style="color:#f92672">(</span>policy ACCEPT 350K packets, 63M bytes<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination

Chain FORWARD <span style="color:#f92672">(</span>policy ACCEPT <span style="color:#ae81ff">0</span> packets, <span style="color:#ae81ff">0</span> bytes<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT <span style="color:#f92672">(</span>policy ACCEPT 18M packets, 1916M bytes<span style="color:#f92672">)</span>
 pkts bytes target     prot opt in     out     source               destination
</code></pre></div><p>We see three default chains, INPUT, FORWARD and OUTPUT, with the first line of output in each chain indicating the chain name (INPUT/FORWARD/OUTPUT in this case), followed by the default policy (ACCEPT).</p>
<p>The following is a proposed structure diagram of iptables, where traffic passes through the INPUT chain and then enters the upper protocol stack, such as:</p>
<p><img src="iptables-chains.jpg" alt="iptables chains"></p>
<p>Multiple rules can be added to each chain and the rules are executed in order from front to back. Let&rsquo;s look at the table header definition of the rule.</p>
<ul>
<li><strong>PKTS</strong>: Number of matched messages processed</li>
<li><strong>bytes</strong>: cumulative packet size processed (bytes)</li>
<li><strong>Target</strong>: If the message matches the rule, the specified target is executed.</li>
<li><strong>PROT</strong>: Protocols such as TDP, UDP, ICMP, and ALL.</li>
<li><strong>opt</strong>: Rarely used, this column is used to display IP options.</li>
<li><strong>IN</strong>: Inbound network interface.</li>
<li><strong>OUT</strong>: Outbound network interface.</li>
<li><strong>source</strong>: the source IP address or subnet of the traffic, the latter being anywhere.</li>
<li><strong>destination</strong>: the destination IP address or subnet of the traffic, or anywhere.</li>
</ul>
<p>There is also a column without a header, shown at the end, which represents the options of the rule, and is used as an extended match condition for the rule to complement the configuration in the previous columns. prot, opt, in, out, source and destination and the column without a header shown after destination together form the match rule. TARGET is executed when traffic matches these rules.</p>
<p><strong>Types supported by TARGET</strong></p>
<p>Target types include ACCEPT, REJECT, DROP, LOG, SNAT, MASQUERADE, DNAT, REDIRECT, RETURN or jump to other rules, etc. You can determine where the telegram is going by executing only one rule in a chain that matches in order, except for the RETURN type, which is similar to the return statement in programming languages, which returns to its call point and continues to execute the next rule.</p>
<p>From the output, you can see that the Init container does not create any rules in the default link of iptables, but instead creates a new link.</p>
<h2 id="traffic-routing-process-explained">Traffic routing process explained</h2>
<p>Traffic routing is divided into two processes, Inbound and Outbound, which will be analyzed in detail for the reader below based on the example above and the configuration of the sidecar.</p>
<h3 id="understand-inbound-handler">Understand Inbound Handler</h3>
<p>The role of the Inbound handler is to pass traffic from the downstream blocked by iptables to the localhost and establish a connection to the application container within the Pod. Assuming the name of one of the Pods is <code>reviews-v1-54b8794ddf-jxksn</code>, run <code>istioctl proxy-config listener reviews-v1-54b8794ddf-jxksn</code> to see which Listener is in that Pod.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">ADDRESS            PORT      TYPE</span>
<span style="color:#a6e22e">172.17.0.15        9080      HTTP &lt;--- Receives all Inbound HTTP traffic, which is the real listening address of the business process.</span>
<span style="color:#a6e22e">172.17.0.15        15020     TCP &lt;--- Ingress Gateway</span>
<span style="color:#a6e22e">10.109.20.166      15012     TCP &lt;--- Istiod http dns</span>
<span style="color:#a6e22e">10.103.34.135      14250     TCP &lt;--+</span>
<span style="color:#a6e22e">10.103.34.135      14267     TCP    |</span>
<span style="color:#a6e22e">10.103.34.135      14268     TCP    |</span>
<span style="color:#a6e22e">10.104.122.175     15020     TCP    |</span>
<span style="color:#a6e22e">10.104.122.175     15029     TCP    |</span>
<span style="color:#a6e22e">10.104.122.175     15030     TCP    |</span>
<span style="color:#a6e22e">10.104.122.175     15031     TCP    |</span>
<span style="color:#a6e22e">10.104.122.175     15032     TCP    |</span>
<span style="color:#a6e22e">10.104.122.175     15443     TCP    |</span>
<span style="color:#a6e22e">10.104.122.175     31400     TCP    | Receive Outbound traffic paired with a 0.0.0.0:15006 listener</span>
<span style="color:#a6e22e">10.104.122.175     443       TCP    |</span>
<span style="color:#a6e22e">10.104.62.18       15443     TCP    |</span>
<span style="color:#a6e22e">10.104.62.18       443       TCP    |</span>
<span style="color:#a6e22e">10.106.201.253     16686     TCP    |</span>
<span style="color:#a6e22e">10.109.20.166      443       TCP    |</span>
<span style="color:#a6e22e">10.96.0.1          443       TCP    |</span>
<span style="color:#a6e22e">10.96.0.10         53        TCP    |</span>
<span style="color:#a6e22e">10.96.0.10         9153      TCP    |</span>
<span style="color:#a6e22e">10.98.184.149      15011     TCP    |</span>
<span style="color:#a6e22e">10.98.184.149      15012     TCP    |</span>
<span style="color:#a6e22e">10.98.184.149      443       TCP    |</span>
<span style="color:#a6e22e">0.0.0.0            14250     TCP    |</span>
<span style="color:#a6e22e">0.0.0.0            15010     TCP    |</span>
<span style="color:#a6e22e">0.0.0.0            15014     TCP    |</span>
<span style="color:#a6e22e">0.0.0.0            15090     HTTP   |</span>
<span style="color:#a6e22e">0.0.0.0            20001     TCP    |</span>
<span style="color:#a6e22e">0.0.0.0            3000      TCP    |</span>
<span style="color:#a6e22e">0.0.0.0            80        TCP    |</span>
<span style="color:#a6e22e">0.0.0.0            8080      TCP    |</span>
<span style="color:#a6e22e">0.0.0.0            9080      TCP    |</span>
<span style="color:#a6e22e">0.0.0.0            9090      TCP    |</span>
<span style="color:#a6e22e">0.0.0.0            9411      TCP &lt;--+</span>
<span style="color:#a6e22e">0.0.0.0            15001     TCP &lt;--- Receive all Outbound traffic intercepted by iptables and forward it to the virtual listener</span>
<span style="color:#a6e22e">0.0.0.0            15006     TCP &lt;--- Receive all Inbound traffic intercepted by iptables and forward it to the virtual listener</span>
</code></pre></div><p>When traffic from productpage arrives at the <code>reviews</code> pod, downstream already knows explicitly that the IP address of the pod is <code>172.17.0.16</code> and that&rsquo;s why the request is <code>172.17.0.15:9080</code>.</p>
<p><strong><code>virtualInbound</code> Listener</strong></p>
<p>As you can see from the Listener list of this Pod, the Listener of <code>0.0.0:15006/TCP</code> (whose real name is virtualInbound) listens to all Inbound traffic, and here is the detailed configuration of this Listener.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;virtualInbound&#34;</span>,
    <span style="color:#f92672">&#34;address&#34;</span>: {
        <span style="color:#f92672">&#34;socketAddress&#34;</span>: {
            <span style="color:#f92672">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
            <span style="color:#f92672">&#34;portValue&#34;</span>: <span style="color:#ae81ff">15006</span>
        }
    },
<span style="color:#f92672">&#34;filterChains&#34;</span>: [
    {
        <span style="color:#f92672">&#34;filters&#34;</span>: [
        <span style="color:#960050;background-color:#1e0010">/*ommit*/</span>
              {
            <span style="color:#f92672">&#34;filterChainMatch&#34;</span>: {
                <span style="color:#f92672">&#34;destinationPort&#34;</span>: <span style="color:#ae81ff">9080</span>,
                <span style="color:#f92672">&#34;prefixRanges&#34;</span>: [
                    {
                        <span style="color:#f92672">&#34;addressPrefix&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.15&#34;</span>,
                        <span style="color:#f92672">&#34;prefixLen&#34;</span>: <span style="color:#ae81ff">32</span>
                    }
                ],
                <span style="color:#f92672">&#34;applicationProtocols&#34;</span>: [
                    <span style="color:#e6db74">&#34;istio-peer-exchange&#34;</span>,
                    <span style="color:#e6db74">&#34;istio&#34;</span>,
                    <span style="color:#e6db74">&#34;istio-http/1.0&#34;</span>,
                    <span style="color:#e6db74">&#34;istio-http/1.1&#34;</span>,
                    <span style="color:#e6db74">&#34;istio-h2&#34;</span>
                ]
            },
            <span style="color:#f92672">&#34;filters&#34;</span>: [
                {
                    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;envoy.filters.network.metadata_exchange&#34;</span>,
                    <span style="color:#f92672">&#34;config&#34;</span>: {
                        <span style="color:#f92672">&#34;protocol&#34;</span>: <span style="color:#e6db74">&#34;istio-peer-exchange&#34;</span>
                    }
                },
                {
                    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;envoy.http_connection_manager&#34;</span>,
                    <span style="color:#f92672">&#34;typedConfig&#34;</span>: {
                        <span style="color:#f92672">&#34;@type&#34;</span>: <span style="color:#e6db74">&#34;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&#34;</span>,
                        <span style="color:#f92672">&#34;statPrefix&#34;</span>: <span style="color:#e6db74">&#34;inbound_172.17.0.15_9080&#34;</span>,
                        <span style="color:#f92672">&#34;routeConfig&#34;</span>: {
                            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;inbound|9080|http|reviews.default.svc.cluster.local&#34;</span>,
                            <span style="color:#f92672">&#34;virtualHosts&#34;</span>: [
                                {
                                    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;inbound|http|9080&#34;</span>,
                                    <span style="color:#f92672">&#34;domains&#34;</span>: [
                                        <span style="color:#e6db74">&#34;*&#34;</span>
                                    ],
                                    <span style="color:#f92672">&#34;routes&#34;</span>: [
                                        {
                                            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
                                            <span style="color:#f92672">&#34;match&#34;</span>: {
                                                <span style="color:#f92672">&#34;prefix&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>
                                            },
                                            <span style="color:#f92672">&#34;route&#34;</span>: {
                                                <span style="color:#f92672">&#34;cluster&#34;</span>: <span style="color:#e6db74">&#34;inbound|9080|http|reviews.default.svc.cluster.local&#34;</span>,
                                                <span style="color:#f92672">&#34;timeout&#34;</span>: <span style="color:#e6db74">&#34;0s&#34;</span>,
                                                <span style="color:#f92672">&#34;maxGrpcTimeout&#34;</span>: <span style="color:#e6db74">&#34;0s&#34;</span>
                                            },
                                            <span style="color:#f92672">&#34;decorator&#34;</span>: {
                                                <span style="color:#f92672">&#34;operation&#34;</span>: <span style="color:#e6db74">&#34;reviews.default.svc.cluster.local:9080/*&#34;</span>
                                            }
                                        }
                                    ]
                                }
                            ],
                            <span style="color:#f92672">&#34;validateClusters&#34;</span>: <span style="color:#66d9ef">false</span>
                        }
  <span style="color:#960050;background-color:#1e0010">/*ommit*/</span>
}
</code></pre></div><p>The traffic from the Inbound handler was diverted to the <code>172.17.0.15_9080</code> Listener by the virtualInbound Listener and we are looking at the configuration of this Listener.</p>
<p>Run <code>istioctl pc listener reviews-v1-54b8794ddf-jxksn --address 172.17.0.15 --port 9080 -o json</code>  to see it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">[
    {
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.15_9080&#34;</span>,
        <span style="color:#f92672">&#34;address&#34;</span>: {
            <span style="color:#f92672">&#34;socketAddress&#34;</span>: {
                <span style="color:#f92672">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;172.17.0.15&#34;</span>,
                <span style="color:#f92672">&#34;portValue&#34;</span>: <span style="color:#ae81ff">9080</span>
            }
        },
        <span style="color:#f92672">&#34;filterChains&#34;</span>: [
            {
                <span style="color:#f92672">&#34;filterChainMatch&#34;</span>: {
                    <span style="color:#f92672">&#34;applicationProtocols&#34;</span>: [
                        <span style="color:#e6db74">&#34;istio-peer-exchange&#34;</span>,
                        <span style="color:#e6db74">&#34;istio&#34;</span>,
                        <span style="color:#e6db74">&#34;istio-http/1.0&#34;</span>,
                        <span style="color:#e6db74">&#34;istio-http/1.1&#34;</span>,
                        <span style="color:#e6db74">&#34;istio-h2&#34;</span>
                    ]
                },
            <span style="color:#f92672">&#34;filters&#34;</span>: [
                {
                    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;envoy.http_connection_manager&#34;</span>,
                    <span style="color:#f92672">&#34;config&#34;</span>: {
                        <span style="color:#960050;background-color:#1e0010">...</span> 
                    <span style="color:#f92672">&#34;routeConfig&#34;</span>: {
                                <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;inbound|9080|http|reviews.default.svc.cluster.local&#34;</span>,
                                <span style="color:#f92672">&#34;virtualHosts&#34;</span>: [
                                    {
                                        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;inbound|http|9080&#34;</span>,
                                        <span style="color:#f92672">&#34;domains&#34;</span>: [
                                            <span style="color:#e6db74">&#34;*&#34;</span>
                                        ],
                                        <span style="color:#f92672">&#34;routes&#34;</span>: [
                                            {
                                                <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
                                                <span style="color:#f92672">&#34;match&#34;</span>: {
                                                    <span style="color:#f92672">&#34;prefix&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>
                                                },
                                                <span style="color:#f92672">&#34;route&#34;</span>: {
                                                    <span style="color:#f92672">&#34;cluster&#34;</span>: <span style="color:#e6db74">&#34;inbound|9080|http|reviews.default.svc.cluster.local&#34;</span>,
                                                    <span style="color:#f92672">&#34;timeout&#34;</span>: <span style="color:#e6db74">&#34;0s&#34;</span>,
                                                    <span style="color:#f92672">&#34;maxGrpcTimeout&#34;</span>: <span style="color:#e6db74">&#34;0s&#34;</span>
                                                },
                                                <span style="color:#f92672">&#34;decorator&#34;</span>: {
                                                    <span style="color:#f92672">&#34;operation&#34;</span>: <span style="color:#e6db74">&#34;reviews.default.svc.cluster.local:9080/*&#34;</span>
                                                }
                                            }
                                        ]
                                    }
                                ],
            }
        <span style="color:#960050;background-color:#1e0010">...</span>
        },
        <span style="color:#960050;background-color:#1e0010">{</span>
            <span style="color:#f92672">&#34;filterChainMatch&#34;</span>: {
                <span style="color:#f92672">&#34;transportProtocol&#34;</span>: <span style="color:#e6db74">&#34;tls&#34;</span>
            },
            <span style="color:#f92672">&#34;tlsContext&#34;</span>: {<span style="color:#960050;background-color:#1e0010">...</span>
            },
            <span style="color:#f92672">&#34;filters&#34;</span>: [<span style="color:#960050;background-color:#1e0010">...</span>
            ]
        }
    ],
<span style="color:#960050;background-color:#1e0010">...</span>
}]
</code></pre></div><p>Let&rsquo;s look at the envoy.http_connection_manager configuration section in filterChains.filters, which indicates that traffic is forwarded to Cluster <code>inbound|9080|http|reviews.default.svc.cluster.local</code> for processing.</p>
<p><strong><a href="https://www.servicemesher.com/istio-handbook/GLOSSARY.html#cluster">Cluster</a> <code>inbound|9080|http|reviews.default.svc.cluster.local</code></strong></p>
<p>Run <code>istioctl proxy-config cluster reviews-v1-54b8794ddf-jxksn --fqdn reviews.default.svc.cluster.local --direction inbound -o json</code>  to see the config of cluster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">[
    {
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;inbound|9080|http|reviews.default.svc.cluster.local&#34;</span>,
        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;STATIC&#34;</span>,
        <span style="color:#f92672">&#34;connectTimeout&#34;</span>: <span style="color:#e6db74">&#34;1s&#34;</span>,
        <span style="color:#f92672">&#34;loadAssignment&#34;</span>: {
            <span style="color:#f92672">&#34;clusterName&#34;</span>: <span style="color:#e6db74">&#34;inbound|9080|http|reviews.default.svc.cluster.local&#34;</span>,
            <span style="color:#f92672">&#34;endpoints&#34;</span>: [
                {
                    <span style="color:#f92672">&#34;lbEndpoints&#34;</span>: [
                        {
                            <span style="color:#f92672">&#34;endpoint&#34;</span>: {
                                <span style="color:#f92672">&#34;address&#34;</span>: {
                                    <span style="color:#f92672">&#34;socketAddress&#34;</span>: {
                                        <span style="color:#f92672">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
                                        <span style="color:#f92672">&#34;portValue&#34;</span>: <span style="color:#ae81ff">9080</span>
                                    }
                                }
                            }
                        }
                    ]
                }
            ]
        },
        <span style="color:#f92672">&#34;circuitBreakers&#34;</span>: {
            <span style="color:#f92672">&#34;thresholds&#34;</span>: [
                {
                    <span style="color:#f92672">&#34;maxConnections&#34;</span>: <span style="color:#ae81ff">4294967295</span>,
                    <span style="color:#f92672">&#34;maxPendingRequests&#34;</span>: <span style="color:#ae81ff">4294967295</span>,
                    <span style="color:#f92672">&#34;maxRequests&#34;</span>: <span style="color:#ae81ff">4294967295</span>,
                    <span style="color:#f92672">&#34;maxRetries&#34;</span>: <span style="color:#ae81ff">4294967295</span>
                }
            ]
        }
    }
]
</code></pre></div><p>You can see that the Endpoint of the Cluster directly corresponds to the localhost, which then forwards the traffic through the iptables and is consumed by the application container.</p>
<h3 id="understand-outbound-handler">Understand Outbound Handler</h3>
<p>Because reviews sends an HTTP request to the ratings service at <code>http://ratings.default.svc.cluster.local:9080/</code>, the role of the Outbound handler is to intercept traffic from the local application to which iptables has intercepted, and determine how to route it to the upstream via sidecar.</p>
<p>Requests from application containers are Outbound traffic, hijacked by iptables and transferred to the Outbound handler for processing, which then passes through the virtualOutbound Listener, the <code>0.0.0.0_9080</code> Listener, and then finds the upstream cluster via Route 9080, which in turn finds the Endpoint via EDS to perform the routing action.</p>
<p><strong>Route <code>ratings.default.svc.cluster.local:9080</code></strong></p>
<p><code>reviews</code> requests the <code>ratings</code> service and runs <code>istioctl proxy-config routes reviews-v1-54b8794ddf-jxksn --name 9080 -o json</code>. View the route configuration because sidecar matches VirtualHost based on domains in the HTTP header, so only <code>ratings.default.svc.cluster.local:9080</code> is listed below for this VirtualHost.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">[{
  <span style="color:#960050;background-color:#1e0010">{</span>
      <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;ratings.default.svc.cluster.local:9080&#34;</span>,
      <span style="color:#f92672">&#34;domains&#34;</span>: [
          <span style="color:#e6db74">&#34;ratings.default.svc.cluster.local&#34;</span>,
          <span style="color:#e6db74">&#34;ratings.default.svc.cluster.local:9080&#34;</span>,
          <span style="color:#e6db74">&#34;ratings&#34;</span>,
          <span style="color:#e6db74">&#34;ratings:9080&#34;</span>,
          <span style="color:#e6db74">&#34;ratings.default.svc.cluster&#34;</span>,
          <span style="color:#e6db74">&#34;ratings.default.svc.cluster:9080&#34;</span>,
          <span style="color:#e6db74">&#34;ratings.default.svc&#34;</span>,
          <span style="color:#e6db74">&#34;ratings.default.svc:9080&#34;</span>,
          <span style="color:#e6db74">&#34;ratings.default&#34;</span>,
          <span style="color:#e6db74">&#34;ratings.default:9080&#34;</span>,
          <span style="color:#e6db74">&#34;10.98.49.62&#34;</span>,
          <span style="color:#e6db74">&#34;10.98.49.62:9080&#34;</span>
      ],
      <span style="color:#f92672">&#34;routes&#34;</span>: [
          {
              <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
              <span style="color:#f92672">&#34;match&#34;</span>: {
                  <span style="color:#f92672">&#34;prefix&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>
              },
              <span style="color:#f92672">&#34;route&#34;</span>: {
                  <span style="color:#f92672">&#34;cluster&#34;</span>: <span style="color:#e6db74">&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span>,
                  <span style="color:#f92672">&#34;timeout&#34;</span>: <span style="color:#e6db74">&#34;0s&#34;</span>,
                  <span style="color:#f92672">&#34;retryPolicy&#34;</span>: {
                      <span style="color:#f92672">&#34;retryOn&#34;</span>: <span style="color:#e6db74">&#34;connect-failure,refused-stream,unavailable,cancelled,resource-exhausted,retriable-status-codes&#34;</span>,
                      <span style="color:#f92672">&#34;numRetries&#34;</span>: <span style="color:#ae81ff">2</span>,
                      <span style="color:#f92672">&#34;retryHostPredicate&#34;</span>: [
                          {
                              <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;envoy.retry_host_predicates.previous_hosts&#34;</span>
                          }
                      ],
                      <span style="color:#f92672">&#34;hostSelectionRetryMaxAttempts&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
                      <span style="color:#f92672">&#34;retriableStatusCodes&#34;</span>: [
                          <span style="color:#ae81ff">503</span>
                      ]
                  },
                  <span style="color:#f92672">&#34;maxGrpcTimeout&#34;</span>: <span style="color:#e6db74">&#34;0s&#34;</span>
              },
              <span style="color:#f92672">&#34;decorator&#34;</span>: {
                  <span style="color:#f92672">&#34;operation&#34;</span>: <span style="color:#e6db74">&#34;ratings.default.svc.cluster.local:9080/*&#34;</span>
              }
          }
      ]
  },
<span style="color:#960050;background-color:#1e0010">..</span>]
</code></pre></div><p>From this Virtual Host configuration, you can see routing traffic to Cluster <code>outbound|9080||ratings.default.svc.cluster.local</code>.</p>
<p><strong>Endpoint <code>outbound|9080||ratings.default.svc.cluster.local</code></strong></p>
<p>Running <code>istioctl proxy-config endpoint reviews-v1-54b8794ddf-jxksn --port 9080 -o json</code> to view the Endpoint configuration, we select only the <code>outbound|9080|||ratings.default.svc.cluster.local</code> Cluster of which the results are as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;clusterName&#34;</span>: <span style="color:#e6db74">&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span>,
  <span style="color:#f92672">&#34;endpoints&#34;</span>: [
    {
      <span style="color:#f92672">&#34;locality&#34;</span>: {

      },
      <span style="color:#f92672">&#34;lbEndpoints&#34;</span>: [
        {
          <span style="color:#f92672">&#34;endpoint&#34;</span>: {
            <span style="color:#f92672">&#34;address&#34;</span>: {
              <span style="color:#f92672">&#34;socketAddress&#34;</span>: {
                <span style="color:#f92672">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;172.33.100.2&#34;</span>,
                <span style="color:#f92672">&#34;portValue&#34;</span>: <span style="color:#ae81ff">9080</span>
              }
            }
          },
          <span style="color:#f92672">&#34;metadata&#34;</span>: {
            <span style="color:#f92672">&#34;filterMetadata&#34;</span>: {
              <span style="color:#f92672">&#34;istio&#34;</span>: {
                  <span style="color:#f92672">&#34;uid&#34;</span>: <span style="color:#e6db74">&#34;kubernetes://ratings-v1-8558d4458d-ns6lk.default&#34;</span>
                }
            }
          }
        }
      ]
    }
  ]
}
</code></pre></div><p>Endpoints can be one or more, and sidecar will select the appropriate Endpoint to route according to certain rules. At this point the <code>Review</code> service has found its upstream service <code>Rating</code>&rsquo;s Endpoint.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This article uses the bookinfo example provided by Istio to guide readers through the implementation details behind sidecar injection, iptables transparent traffic hijacking, and traffic routing in sidecar. sidecar mode and traffic transparent hijacking are the features and basic functions of Istio service mesh, understanding the process behind this function and the implementation details will help you understand the principle of service mesh and the content in the later chapters of the <a href="https://www.servicemesher.com/istio-handbook">Istio Handbook</a>, so I hope readers can try it from scratch in their own environment to deepen their understanding.</p>
<p>Using iptables for traffic hijacking is just one of the ways to do traffic hijacking in the data plane of a service mesh, and there are many more traffic hijacking scenarios, quoted below from the description of the traffic hijacking section given in the MOSN official network of the cloud-native network proxy.</p>
<h3 id="problems-with-using-iptables-for-traffic-hijacking">Problems with using iptables for traffic hijacking</h3>
<p>Currently Istio uses iptables for transparent hijacking and there are three main problems.</p>
<ol>
<li>the need to use the conntrack module for connection tracking, in the case of a large number of connections, will cause a large consumption, and may cause the track table to be full, in order to avoid this problem, the industry has a practice of closing conntrack.</li>
<li>iptables is a common module with global effect and cannot explicitly prohibit associated changes, which is less controllable.</li>
<li>iptables redirect traffic is essentially exchanging data via a loopback. outbond traffic will traverse the protocol stack twice and lose forwarding performance in a large concurrency scenario.</li>
</ol>
<p>Several of the above problems are not present in all scenarios, let&rsquo;s say some scenarios where the number of connections is not large and the NAT table is not used, iptables is a simple solution that meets the requirements. In order to adapt to a wider range of scenarios, transparent hijacking needs to address all three of these issues.</p>
<h3 id="transparent-hijacking-optimization">Transparent hijacking optimization</h3>
<p><strong>Handling inbound traffic with tproxy</strong></p>
<p>tproxy can be used for redirection of inbound traffic without changing the destination IP/port in the packet, without performing connection tracking, and without the problem of conntrack modules creating a large number of connections. Restricted to the kernel version, tproxy&rsquo;s application to outbound is flawed. Istio currently supports handling inbound traffic via tproxy.</p>
<p><strong>Use hook connect to handle outbound traffic</strong></p>
<p>In order to adapt to more application scenarios, the outbound direction is implemented by hook connect, which is implemented as follows.</p>
<p><img src="hook-connect.jpg" alt="hook-connect "></p>
<p>Whichever transparent hijacking scheme is used, the problem of obtaining the real destination IP/port needs to be solved, using the iptables scheme through getsockopt, tproxy can read the destination address directly, by modifying the call interface, hok connect scheme reads in a similar way to tproxy.</p>
<p>After transparent hijacking, sockmap can shorten the packet traversal path and improve forwarding performance in the outbound direction, provided that the kernel version meets the requirements (4.16 and above).</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://istio.io/docs/ops/diagnostic-tools/proxy-cmd/">Debugging Envoy and Istiod - istio.io</a></li>
<li><a href="https://istio.io/blog/2019/data-plane-setup/">Demystifying Istio&rsquo;s Sidecar Injection Model - istio.io</a></li>
<li><a href="https://mosn.io/zh/docs/concept/traffic-hijack/">The traffic hijacking solution when MOSN is used as a sidecar - mosn.io</a></li>
</ul>

          </div>
          
          
          <div class="col-12">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "wikieden" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          
        </div>
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
  <!-- categories -->
  <div class="bg-white mb-5">
    <h4 class="mb-4">Categories</h4>
    <ul class="list-unstyled">
      <li class="border-bottom"><a href="/en/categories/automation-system" class="d-block pb-3 mt-3">Automation system</a></li>
      <li class="border-bottom"><a href="/en/categories/cloud-native" class="d-block pb-3 mt-3">Cloud native</a></li>
      <li class="border-bottom"><a href="/en/categories/deep-learning" class="d-block pb-3 mt-3">Deep learning</a></li>
      <li class="border-bottom"><a href="/en/categories/eco-system" class="d-block pb-3 mt-3">Eco system</a></li>
      <li class="border-bottom"><a href="/en/categories/education-system" class="d-block pb-3 mt-3">Education system</a></li>
      <li class="border-bottom"><a href="/en/categories/english-learning" class="d-block pb-3 mt-3">English learning</a></li>
      <li class="border-bottom"><a href="/en/categories/istio" class="d-block pb-3 mt-3">Istio</a></li>
      <li class="border-bottom"><a href="/en/categories/mathmatics-learning" class="d-block pb-3 mt-3">Mathmatics learning</a></li>
      <li class="border-bottom"><a href="/en/categories/open-source" class="d-block pb-3 mt-3">Open source</a></li>
      <li class="border-bottom"><a href="/en/categories/private" class="d-block pb-3 mt-3">Private</a></li>
      <li class="border-bottom"><a href="/en/categories/service-mesh" class="d-block pb-3 mt-3">Service mesh</a></li>
    </ul>
  </div>
  <!-- tags -->
  <div class="bg-white mb-5">
    <h4 class="mb-4">Tags</h4>
    <ul class="list-inline tag-list">
      <li class="list-inline-item mb-2"><a href="/en/tags/advice">Advice</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/ai">Ai</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/automation">Automation</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/cncf">Cncf</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/eco">Eco</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/education">Education</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/english">English</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/envoy">Envoy</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/iptables">Iptables</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/istio">Istio</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/kubernetes">Kubernetes</a></li>
      <li class="list-inline-item mb-2"><a href="/en/tags/rules">Rules</a></li>
    </ul>
  </div>
  <!-- latest post -->
  <div class="bg-white">
    <h4 class="mb-4">Latest Article</h4>
    <!-- post-item -->
    
    <div class="media border-bottom border-color pb-3 mb-3">
      <a href="http://wikieden.github.io/en/blog/istio-18-a-virtual-machine-integration-odyssey/"><img class="mr-3 post-thumb-sm" src="http://wikieden.github.io/images/banner/vm.jpg"></a>
      <div class="media-body">
        <a href="http://wikieden.github.io/en/blog/istio-18-a-virtual-machine-integration-odyssey/">
          <h5 class="mt-0">Istio 1.8: A Virtual Machine Integration Odyssey</h5>
        </a>
        23 Jan 2021
      </div>
    </div>
    
    <div class="media border-bottom border-color pb-3 mb-3">
      <a href="http://wikieden.github.io/en/blog/what-is-a-service-mesh/"><img class="mr-3 post-thumb-sm" src="http://wikieden.github.io/images/banner/service-mesh-banner.jpg"></a>
      <div class="media-body">
        <a href="http://wikieden.github.io/en/blog/what-is-a-service-mesh/">
          <h5 class="mt-0">What is a service mesh?</h5>
        </a>
        22 Jan 2021
      </div>
    </div>
    
    <div class="media border-bottom border-color pb-3 mb-3">
      <a href="http://wikieden.github.io/en/blog/istio-1-8-a-smart-dns-proxy-takes-support-for-virtual-machines-a-step-further/"><img class="mr-3 post-thumb-sm" src="http://wikieden.github.io/images/banner/istio18.jpg"></a>
      <div class="media-body">
        <a href="http://wikieden.github.io/en/blog/istio-1-8-a-smart-dns-proxy-takes-support-for-virtual-machines-a-step-further/">
          <h5 class="mt-0">Istio 1.8: A Smart DNS Proxy Takes Support for Virtual Machines a Step Further</h5>
        </a>
        19 Nov 2020
      </div>
    </div>
    
  </div>
  
<div class="bg-white py-5 box-shadow mb-5 sticky-top aside-toc d-none d-sm-block">
	<h4 class="mb-4"></h4>
	<nav id="TableOfContents">
  <ul>
    <li><a href="#sidecar-pattern">Sidecar pattern</a>
      <ul>
        <li><a href="#advantages-of-using-the-sidecar-pattern">Advantages of using the Sidecar pattern</a></li>
      </ul>
    </li>
    <li><a href="#sidecar-injection-in-istio">Sidecar injection in Istio</a>
      <ul>
        <li><a href="#init-container">Init container</a></li>
      </ul>
    </li>
    <li><a href="#sidecar-injection-example-analysis">Sidecar injection example analysis</a></li>
    <li><a href="#init-container-analysis">Init container analysis</a>
      <ul>
        <li><a href="#init-container-initiation">Init container initiation</a></li>
      </ul>
    </li>
    <li><a href="#iptables-manipulation-analysis">iptables manipulation analysis</a>
      <ul>
        <li><a href="#understand-iptables">Understand iptables</a></li>
        <li><a href="#iptables">iptables</a></li>
        <li><a href="#understand-iptables-rules">Understand iptables rules</a></li>
      </ul>
    </li>
    <li><a href="#traffic-routing-process-explained">Traffic routing process explained</a>
      <ul>
        <li><a href="#understand-inbound-handler">Understand Inbound Handler</a></li>
        <li><a href="#understand-outbound-handler">Understand Outbound Handler</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a>
      <ul>
        <li><a href="#problems-with-using-iptables-for-traffic-hijacking">Problems with using iptables for traffic hijacking</a></li>
        <li><a href="#transparent-hijacking-optimization">Transparent hijacking optimization</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
</div>
</aside>
<!-- /sidebar -->
      
    </div>
  </div>
</section>



<footer>
  
  
  
  <div class="footer bg-footer section border-bottom">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-sm-8 mb-5 mb-lg-0">
          
          <a class="logo-footer" href="/en"><img class="img-fluid mb-4" src="http://wikieden.github.io/images/logo.jpg" alt="Laughman&#39;s Voloblog about CloudNative/AR/VR/CV"></a>
          <ul class="list-unstyled">
            <li class="mb-4"></li>
            <li class="mb-4"></li>
            <li class="mb-4"></li>
          </ul>
        </div>
        
        <div class="col-lg-2 col-sm-4 col-6 mb-5 mb-md-0">
          <h4 class="text-white mb-5 text-uppercase">links</h4>
          <ul class="list-unstyled">
            
            <li class="mb-3"><a class="text-color" href="http://wikieden.github.io/en/event">event</a></li>
            
            <li class="mb-3"><a class="text-color" href="http://wikieden.github.io/en/notice">notice</a></li>
            
            <li class="mb-3"><a class="text-color" href="http://wikieden.github.io/en/research">research</a></li>
            
            <li class="mb-3"><a class="text-color" href="http://wikieden.github.io/en/scholarship">scholarship</a></li>
            
            <li class="mb-3"><a class="text-color" href="http://wikieden.github.io/en/teacher">teacher</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <div class="copyright py-4 bg-footer">
    <div class="container">
      <div class="row">
        <div class="col-sm-7 text-sm-left text-center">
          <p class="mb-0">Copyright © 2021 wikiedn</p>
        </div>
        <div class="col-sm-5 text-sm-right text-center">
          <ul class="list-inline">
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="#"><i class="ti-facebook text-primary"></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="#"><i class="ti-twitter-alt text-primary"></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="#"><i class="ti-instagram text-primary"></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="#"><i class="ti-github text-primary"></i></a></li>
            
            <li class="list-inline-item"><a class="d-inline-block p-2" href="#"><i class="ti-linkedin text-primary"></i></a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>


<!-- Google Map API -->

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBu5nZKbeK-WHQ70oqOWo-_4VmwOwKP9YQ"></script>


<!-- JS Plugins -->

<script src="http://wikieden.github.io/plugins/jQuery/jquery.min.js"></script>

<script src="http://wikieden.github.io/plugins/bootstrap/bootstrap.min.js"></script>

<script src="http://wikieden.github.io/plugins/slick/slick.min.js"></script>

<script src="http://wikieden.github.io/plugins/venobox/venobox.min.js"></script>

<script src="http://wikieden.github.io/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="http://wikieden.github.io/plugins/google-map/gmap.js"></script>


<!-- Main Script -->

<script src="http://wikieden.github.io/js/script.min.js"></script>

<!-- google analitycs -->





<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
	This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button" class="btn btn-sm btn-outline-primary ml-2">I Accept</span>
</div>
<script>
	(function ($) {
		const cookieBox = document.getElementById('js-cookie-box');
		const cookieButton = document.getElementById('js-cookie-button');
		if (!Cookies.get('cookie-box')) {
			cookieBox.classList.remove('cookie-box-hide');
			cookieButton.onclick = function () {
				Cookies.set('cookie-box', true, {
					expires:  2 
				});
				cookieBox.classList.add('cookie-box-hide');
			};
		}
	})(jQuery);
</script>


<style>
.cookie-box {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  text-align: center;
  z-index: 9999;
  padding: 1rem 2rem;
  background: rgb(71, 71, 71);
  transition: all .75s cubic-bezier(.19, 1, .22, 1);
  color: #fdfdfd;
}

.cookie-box-hide {
  display: none;
}
</style>
</body>

</html>